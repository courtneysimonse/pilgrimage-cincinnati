<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>Cincinnati Pilgrimage Trails</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link href='https://api.mapbox.com/mapbox-assembly/v0.20.0/assembly.min.css' rel='stylesheet'>
  <link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
  <!-- <link href='css/styles.css' rel='stylesheet' /> -->

  <style>

  </style>
</head>

<body>
  <div class='flex-parent viewport-full relative scroll-hidden'>
    <div class='flex-child w-full w300-ml absolute static-ml left bottom'>
      <div class='flex-parent flex-parent--column viewport-third h-full-ml hmax-full bg-white py18 px12'>
        <div class='flex-child flex-child--grow px12 py12 scroll-auto'>
          <h1 class='txt-h1 mb6'>Archdiocese of Cincinnati Pilgrimage Trails</h1>
          <a href='#' id='geolocate' class='btn btn--s'>Find me</a>
          <!-- <p></p> -->
          <div id='description'></div>
          <div id='directions'></div>
        </div>
        <footer class='px12 py12 bg-gray-faint txt-s'>
          <ul>
            <li>Learn more about the
              <a class='link' target="_blank" href='https://www.pilgrimageoffaith.org/'>Pilgrimage of Faith.</a>
              These trails were developed for the Archdiocese of Cincinnati's Catholic Committee of Scouting.
            </li>
            <li>Map authored by
              <a class='link' target="_blank" href='https://courtneysimonse.github.io/'>Courtney Simonse</a>
            </li>
          </ul>
        </footer>
      </div>
    </div>
    <div class='flex-child flex-child--grow viewport-twothirds viewport-full-ml'>
      <div id="map" class='viewport-twothirds viewport-full-ml'></div>
    </div>
  </div>

  <!-- ui info panel -->
  <!-- <div id='info' class='py6 px12 bg-white border border--gray-light round absolute w240'>
    <p>Name:
      <span></span>
    </p>
  </div> -->

  <!-- ui controls for layer selection -->
  <div id='ui-controls'>
  	  <select id="trails"></select>
  </div> <!-- end ui-controls -->


  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.20.0/assembly.js"></script>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
  <!-- <script src="data/trails.js"></script> -->

  <script>

    L.mapbox.accessToken = 'pk.eyJ1IjoiY291cnRuZXlzaW1vbnNlIiwiYSI6ImNqZGozNng0NjFqZWIyd28xdDJ2MXduNTcifQ.PoSFtqfsq1di1IDXzlN4PA';

    var options = {
      zoomSnap: .1,
      center: [39.2, -84.5], // cincinnati downtown
      zoom: 11,
      minZoom: 6,
      // maxZoom: 15
    }

    var map = L.map('map', options);

    // request tiles and add to map
    var Stamen_Terrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      subdomains: 'abcd',
      minZoom: 0,
      maxZoom: 18,
      ext: 'png'
    }).addTo(map);

    // trail names
    var layerInfo = {
      cathedralShort: {name:"Cathedral Trail 5 mi"},
      cathedralLong: {name:"Cathedral Trail 11.4 mi"},
      eastSideEast: {name:"East Side Trail - East Route"},
      westSideSouth: {name:"West Side Trail - South Loop"},
      westSideNorth: {name:"West Side Trail - North Loop"},
      central: {name:"Central Trail"},
      north: {name:"North Trail"},
      eastSideWest1: {name:"East Side Trail - West Route Option 1"},
      eastSideWest2: {name:"East Side Trail - West Route Option 2"}
    };

    var dropdownList = '';

    // create dropdown list HTML
    for (var layer in layerInfo) {
      dropdownList += '<option value="' + layerInfo[layer]['name'] +'">' + layerInfo[layer]['name'] + '</option>'
    }
    // console.log(dropdownList);
    $("#trails").html(dropdownList)

    // selectedTrail is one chosen by dropdown
    var selectedTrail = document.getElementById('trails').value;
    // console.log(selectedTrail);

    // icon for churches
    var churchIcon = L.icon({
      iconUrl: "images/church.svg",
      iconSize: [15,15],
    })

    // add church points
    // use JQuery to import XML data
    $(document).ready(function() {
      $.ajax({
        type: "GET",
        url: "data/parish-locations.xml",
        dataType: "xml",
        success: parseXML
      });
    });

    var churchLayer = new L.layerGroup();

    // add church data from XML file
    function parseXML(xml) {
      $(xml).find("marker").each(function() {
        churchPoint = L.marker([$(this).attr("lat"), $(this).attr("lng")], {
          icon: churchIcon
        }).bindPopup("<h3><b>name:</b> " + $(this).attr("name") + "</h3><p><b>Mass times:</b> " + $(this).attr("Masses") +
              "</p><p><b>Confession:</b>" + $(this).attr("ConfessionTimes") + "</p>")
          .addTo(churchLayer);
      });
    }
    churchLayer.addTo(map);

    // trailsLayers = {};

    // add route data to map
    $.getJSON("data/trails.geojson", function(trails) {
      // filter for selected trail - better to do this in the updateMap function?
      // for (var layer in layerInfo) {
      //   trailsLayers[layer] = L.geoJson(data, {
      //     filter: function(feature) {
      //       if (feature.properties.name == layerInfo[layer]["name"]) {
      //         return feature;
      //       }
      //     },
      //     style: function(feature) {
      //       return {dashArray: [5,5]};
      //     }
      //   }).addTo(map);
      // }
      drawMap(trails);
    });

    // console.log(trailsLayers);

    // addUi(trailsLayers, layerInfo)

    // geolocation example from Mapbox - getting error "TypeError: myLayer.setGeoJSON is not a function"
    var geolocate = document.getElementById('geolocate');

    var myLayer = L.mapbox.featureLayer().addTo(map);

    // find user's location through browser
    if (!navigator.geolocation) {
        geolocate.innerHTML = 'Geolocation is not available';
    } else {
        geolocate.onclick = function (e) {
            e.preventDefault();
            e.stopPropagation();
            map.locate();
        };
    }

    // zoom and center the map on position and add marker
    map.on('locationfound', function(e) {
        map.fitBounds(e.bounds);

        myLayer.setGeoJSON({
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [e.latlng.lng, e.latlng.lat]
            },
            properties: {
                'title': 'Here I am!',
                'marker-color': '#ff8888',
                'marker-symbol': 'star'
            }
        });

    });

    // If the user chooses not to allow their location
    // to be shared, display an error message.
    map.on('locationerror', function() {
        geolocate.innerHTML = 'Position could not be found';
    });

    function drawMap(trails) {
      var dataLayer = L.geoJson(trails, {
        // style trail lines
        style: function(feature) {
          return {
            color: 'black',
            weight: 1,
            dashArray: [5,5]
          };
        },
        onEachFeature: function(feature, layer) {
          // when mousing over a layer - doesn't seem to work well since you have to mouseover exactly the line - maybe remove?
          layer.on('mouseover', function() {

            // change the stroke color and bring that element to the front
            layer.setStyle({
              color: 'yellow',
            })//.bringToFront();
          });

          // on mousing off layer
          layer.on('mouseout', function() {

            // reset the layer style to its original stroke color
            layer.setStyle({
              color: 'black',
            });
          });
        }
      }).addTo(map);

      addUi(dataLayer);
      // show short cathedral trail as default
      updateMap(dataLayer, 'Cathedral Trail 5 mi');

    } // end drawMap

    function addUi(dataLayer) {
      // create the dropdown
      var selectControl = L.control({ position: 'topright' });
      // when control is added
      selectControl.onAdd = function(map) {
        // get the element with id attribute of ui-controls
        return L.DomUtil.get("ui-controls");
      }
      // add the control to the map
      selectControl.addTo(map);

      $('select[id="trails"]')
        .change(function() {
        // code executed here when change event occurs
        selectedTrail = this.value;
        console.log(selectedTrail);
        // call updateMap function
        updateMap(dataLayer, selectedTrail);

      });
    } // end addUi

    function updateMap(dataLayer, selectedTrail) {
      // console.log(dataLayer.getLayers());
      // dataLayer.removeFrom(map);
      dataLayer.eachLayer(function(layer) {
        // console.log(layer);
        if (layer.feature.properties["name"] == selectedTrail) {
          // console.log(layer);
          console.log(layer.feature.properties.stops);
          // add description of trail
          $("#description").html("<h2>Trail: " + selectedTrail + "</h3>" +
              layer.feature.properties["description"])

          var stopsText = "<h2>Directions</h2><ol class='txt-ol'>"
          var directionsText = ""

          // console.log(layer.feature.properties.stops.features.length-1);

          // add stops and turn by turn directions as info
          for (var i = 0; i < layer.feature.properties.stops.features.length; i++) {
            var stopsProps = layer.feature.properties.stops.features[i].properties;
            // console.log(stopsProps.description);
            // console.log(layer.feature.properties.stops.features[i].geometry.coordinates);
            var stopPosition = layer.feature.properties.stops.features[i].geometry.coordinates // find coordinate for stop
            stopsText += "<li class='text-li' data-position='"+stopPosition[1]+","+stopPosition[0]+
                "' stop="+i+">"+stopsProps.description+"</li>";

            for (var j = 0; j < stopsProps.directions.features.length; j++) {
              // console.log(stopsProps.directions.features[i].properties.description);
              if (j == 0) {
                directionsText += "<ul class='txt-ul'>"
              }
              var turnPosition = stopsProps.directions.features[j].geometry.coordinates // find coordinate for turn
              // console.log(turnPosition);
              directionsText += "<li class='text-li' data-position="+turnPosition[1]+","+turnPosition[0]+">"+
              stopsProps.directions.features[j].properties.description+"</li>";
            }
            stopsText += directionsText + "</ul>"
            directionsText = ""
          }
          stopsText += "</ol>"
          $("#directions").html(stopsText)
          return layer;
        } else {
          // want to only show selected trail - not sure how to do this
          // layer.remove();
        }
      }).addTo(map);

      // add click function to directions list
      $('li').click (function() {
        var position = ($(this).attr('data-position').split(","));
        console.log($(this).attr('data-position').split(","));
        var zoom = 16;
        map.setView(position,zoom,{animation: true}); // set map view to zoom to clicked element

      });
    } // end updateMap


  </script>

  </body>

  </html>

<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>Cincinnati Pilgrimage Trails</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link href='https://api.mapbox.com/mapbox-assembly/v0.20.0/assembly.min.css' rel='stylesheet'>
  <link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
  <link href='css/styles.css' rel='stylesheet' />

  <style>

  </style>
</head>

<body>
  <div class='flex-parent viewport-full relative scroll-hidden'>
    <div class='flex-child w-full w300-ml absolute static-ml left bottom'>
      <div class='flex-parent flex-parent--column viewport-third h-full-ml hmax-full bg-white py18 px12'>
        <div class='flex-child flex-child--grow px12 py12 scroll-auto'>
          <h1 class='txt-h1 mb6'>Archdiocese of Cincinnati Pilgrimage Trails</h1>
          <a href='#' id='geolocate' class='ui-button'>Find me</a>
          <!-- <p></p> -->
        </div>
        <footer class='px12 py12 bg-gray-faint txt-s'>
          <ul>
            <li>Learn more about the
              <a class='link' target="_blank" href='https://www.pilgrimageoffaith.org/'>Pilgrimage of Faith.</a>
              These trails were developed for the Archdiocese of Cincinnati's Catholic Committee of Scouting.
            </li>
            <li>Map authored by
              <a class='link' target="_blank" href='https://courtneysimonse.github.io/'>Courtney Simonse</a>
            </li>
          </ul>
        </footer>
      </div>
    </div>
    <div class='flex-child flex-child--grow viewport-twothirds viewport-full-ml'>
      <div id="map" class='viewport-twothirds viewport-full-ml'></div>
    </div>
  </div>

  <!-- ui info panel -->
  <div id='info' class='py6 px12 bg-white border border--gray-light round absolute w240'>
    <p>Name:
      <span></span>
    </p>
  </div>

  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.20.0/assembly.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.5/chroma.min.js"></script>

  <script>
    L.mapbox.accessToken = 'pk.eyJ1IjoiY291cnRuZXlzaW1vbnNlIiwiYSI6ImNqZGozNng0NjFqZWIyd28xdDJ2MXduNTcifQ.PoSFtqfsq1di1IDXzlN4PA';

    var map = L.mapbox.map('map', 'mapbox.streets', {
      zoomSnap: .1,
      center: [39.1, -84.5],
      zoom: 9,
      minZoom: 6,
      maxZoom: 15,
      // maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
    });

    var geolocate = document.getElementById('geolocate');

    var myLayer = L.mapbox.featureLayer().addTo(map);

    // This uses the HTML5 geolocation API, which is available on
    // most mobile browsers and modern browsers, but not in Internet Explorer
    //
    // See this chart of compatibility for details:
    // http://caniuse.com/#feat=geolocation
    if (!navigator.geolocation) {
        geolocate.innerHTML = 'Geolocation is not available';
    } else {
        geolocate.onclick = function (e) {
            e.preventDefault();
            e.stopPropagation();
            map.locate();
        };
    }

    // Once we've got a position, zoom and center the map
    // on it, and add a single marker.
    map.on('locationfound', function(e) {
        // map.fitBounds(e.bounds);

        myLayer.setGeoJSON({
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [e.latlng.lng, e.latlng.lat]
            },
            properties: {
                'title': 'Here I am!',
                'marker-color': '#ff8888',
                'marker-symbol': 'star'
            }
        });

        // And hide the geolocation button
        geolocate.parentNode.removeChild(geolocate);
    });

    // If the user chooses not to allow their location
    // to be shared, display an error message.
    map.on('locationerror', function() {
        geolocate.innerHTML = 'Position could not be found';
    });

    var colors = chroma.brewer.Accent;
    console.log(colors);

    // add route data to map
    var trails = $.getJSON("data/trails.geojson", function(data) {
      // L.geoJSON(data).eachLayer(function(layer) {
      //   layer.bindPopup(layer.feature.properties["name"])
      //   console.log(layer);
      // }).addTo(map);
      drawMap(data);
    });

    // use JQuery to import XML data
    $(document).ready(function() {
      $.ajax({
        type: "GET",
        url: "data/parish-locations.xml",
        dataType: "xml",
        success: parseXML
      });
    });

    var churchLayer = new L.layerGroup();

    // add church data from XML file
    function parseXML(xml) {
      $(xml).find("marker").each(function() {
        churchPoint = L.marker([$(this).attr("lat"), $(this).attr("lng")])
          // .bindPopup($(this).attr("name"))
          .addTo(churchLayer);
      });
    }
    churchLayer.addTo(map);
    console.log(churchLayer);
    retrieveInfo(churchLayer)

    function drawMap(data) {
      var options = {
          pointToLayer: function (feature, ll) {
            return L.circleMarker(ll, {
                opacity: 1,
                weight: 2,
                fillOpacity: 0,
            })
          }
      }
      // create 2 separate layers from GeoJSON data
      var trailsLayer = L.geoJson(data, options).addTo(map);

      // fit the bounds of the map to one of the layers
      map.fitBounds(trailsLayer.getBounds());

      // adjust zoom level of map
      map.setZoom(map.getZoom() - .4);

      console.log(trailsLayer);
      trailsLayer.setStyle({
          dashArray: [5,5]
      });

    } // end drawMap


    function retrieveInfo(churchLayer) {
      // select the element and reference with variable
      // and hide it from view initially
      var info = $('#info').hide();

      churchLayer.on('mouseover', function (e) {

        // remove the none class to display and show
        info.show();

        // access properties of target layer
        var props = e.layer.feature.properties;

        // populate HTML elements with relevant info
        $('#info span').html(props.name);

        // raise opacity level as visual affordance
        e.layer.setStyle({
          color: "orange"
        });

      });
      // hide the info panel when mousing off layergroup and remove affordance opacity
      churchLayer.on('mouseout', function(e) {

        // hide the info panel
        info.hide();

        // reset the layer style
        e.layer.setStyle({
          color: "blue"
        });
      });

      // when the mouse moves on the document
      $(document).mousemove(function(e) {
          // first offset from the mouse position of the info window
          info.css({
              "left": e.pageX + 6,
              "top": e.pageY - info.height() - 25
          });

          // if it crashes into the top, flip it lower right
          if (info.offset().top < 4) {
              info.css({
                  "top": e.pageY + 15
              });
          }
          // if it crashes into the right, flip it to the left
          if (info.offset().left + info.width() >= $(document).width() - 40) {
              info.css({
                  "left": e.pageX - info.width() - 80
              });
          }
      });
    } // end retrieveInfo


</script>

</body>

</html>
